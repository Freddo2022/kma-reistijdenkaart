<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>DTM ReistijdenKaart</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: Arial, sans-serif; }

    #map {
      width: calc(100% - 40px);
      height: 90vh;
      margin: 10px 20px 20px 20px;
      border-radius: 6px;
    }

    #status {
      margin-top: 5px;
      font-size: 13px;
      color: #444;
      margin-left: 20px;
      margin-right: 20px;
    }

    .top-bar {
      padding: 20px 20px 10px 20px;
      margin-bottom: 10px;
    }

    .top-bar h2 { margin-top: 0; }

    /* Optioneel: subtiele demo styling */
    body.demo .top-bar h2::after {
      content: " (DEMO)";
      font-size: 0.8em;
      margin-left: 6px;
    }
  </style>
</head>

<body>
<div id="legend" style="
  position:absolute;
  bottom:20px;
  right:20px;
  background:white;
  padding:10px;
  border-radius:6px;
  box-shadow:0 0 10px rgba(0,0,0,0.3);
  font-size:14px;
  line-height:1.4;
  z-index:9999;
">
  <b>Reistijd (min)</b><br>
  <div><span style="background:#2c7bb6;width:20px;height:12px;display:inline-block;margin-right:5px;"></span> 0‚Äì10</div>
  <div><span style="background:#abd9e9;width:20px;height:12px;display:inline-block;margin-right:5px;"></span> 10‚Äì20</div>
  <div><span style="background:#ffffbf;width:20px;height:12px;display:inline-block;margin-right:5px;"></span> 20‚Äì30</div>
  <div><span style="background:#fdae61;width:20px;height:12px;display:inline-block;margin-right:5px;"></span> 30‚Äì45</div>
  <div><span style="background:#f46d43;width:20px;height:12px;display:inline-block;margin-right:5px;"></span> 45‚Äì60</div>
  <div><span style="background:#d7191c;width:20px;height:12px;display:inline-block;margin-right:5px;"></span> > 60</div>
</div>

<div class="top-bar">
  <h2>ReistijdenKaart | DriveTimeMatrix (DTM-4PC)</h2>

  <select id="originSelect">
    <option value="">Kies een PC4 postcodegebied...</option>
  </select>

  <label>Kies reistijd (min): </label>
  <input id="iso_min" type="range" min="5" max="240" value="20" step="10" oninput="updateIsoLabel(this.value)">
  <span id="iso_value">60</span> min
  <button style="margin-left:12px;" onclick="showIsochrone()">‚ñ∂Ô∏è Toon Afstanden en Reistijden</button>

  <button style="margin-left:80px;" onclick="resetMap()">üîÑ Reset DTM ReistijdenKaart</button>

  <button style="margin-right:10px;" onclick="downloadCSV()">‚¨áÔ∏è Download selectie (CSV)</button>

  <button
    style="margin-left:70px; background-color:#ccffcc; padding:8px 14px; border:1px solid #99dd99; border-radius:4px;"
    onclick="window.open('https://www.kilometerafstanden.nl/drive-time-matrix.htm', '_blank')">
    ‚ÑπÔ∏è Informatie DriveTimeMatrix (DTM)
  </button>

  <button
    style="margin-left:10px; background-color:#ccffcc; padding:8px 14px; border:1px solid #99dd99; border-radius:4px;"
    onclick="window.open('https://www.kilometerafstanden.nl/dtm-api-drivetimematrix-reistijd-afstand.htm', '_blank')">
    ‚ÑπÔ∏è Informatie API DTM
  </button>
</div>

<div id="status"></div>
<div id="map"></div>

<script>
console.log("DTM ReistijdenKaart | build 2026-01-08 (sqlite+compact arrays + faster render)");

// ------------------------------------------------------------
// 1) API KEY uit URL + helper
// ------------------------------------------------------------
const params = new URLSearchParams(window.location.search);
const API_KEY = params.get("t") || params.get("key");

if (!API_KEY) {
  document.body.innerHTML = `
    <div style="padding:40px;font-family:Arial">
      <h2>üîí Toegang vereist</h2>
      <p>Deze reistijdenkaart is alleen toegankelijk met een geldige toegangstoken.</p>
      <p>Gebruik bijvoorbeeld: <code>/?t=JOUW_SLEUTEL</code></p>
    </div>
  `;
  throw new Error("Geen API key/token in URL");
}

function apiUrl(pathAndQuery) {
  const sep = pathAndQuery.includes("?") ? "&" : "?";
  return `${pathAndQuery}${sep}t=${encodeURIComponent(API_KEY)}`;
}

// ------------------------------------------------------------
// 2) Config ophalen (titel/demo/csv limit)
// ------------------------------------------------------------
let APP_CFG = { plan: "pro", title: "DTM ReistijdenKaart", csv_max_rows: null };

fetch(apiUrl("/api/v1/me"))
  .then(async r => {
    if (!r.ok) throw new Error("me failed: " + r.status);
    return r.json();
  })
  .then(cfg => {
    APP_CFG = { ...APP_CFG, ...cfg };

    if (APP_CFG.title) {
      document.title = APP_CFG.title;
      const h2 = document.querySelector(".top-bar h2");
      if (h2) h2.textContent = APP_CFG.title;
    }

    if (APP_CFG.plan === "demo") {
      document.body.classList.add("demo");
    }
  })
  .catch(err => {
    console.error("Config laden mislukt:", err);
  });

/* ------------------------------------------------------------
   HULPFUNCTIE
------------------------------------------------------------ */
function norm(pc4) {
  return String(pc4).padStart(4, "0");
}

/* ------------------------------------------------------------
   MAP BASIS
------------------------------------------------------------ */
const map = L.map("map").setView([52.1, 5.3], 8);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 14,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

setTimeout(() => map.invalidateSize(), 50);

map.createPane("pc4pane");
map.getPane("pc4pane").style.zIndex = 400;

map.createPane("isochronepane");
map.getPane("isochronepane").style.zIndex = 300;

let pc4Layer = null;
let isochroneLayer = null;

let currentOrigin = null;
let currentTimes = {};       // pc4 -> time_min
let currentDistances = {};   // pc4 -> distance_km

// In plaats van lastResults (objecten), bewaren we arrays (veel sneller/lichter)
let lastDest = [];
let lastT = [];
let lastD = []; // deci-km (0.1 km)

const statusEl = document.getElementById("status");

/* ------------------------------------------------------------
   PC4 GEOJSON LADEN
------------------------------------------------------------ */
fetch("/pc4")
  .then(async r => {
    if (!r.ok) throw new Error("pc4 fetch failed: " + r.status);
    return r.json();
  })
  .then(geojson => {

    pc4Layer = L.geoJSON(geojson, {
      pane: "pc4pane",
      style: {
        color: "#555",
        weight: 0.5,
        fillOpacity: 0.2
      },
      onEachFeature: (feature, layer) => {
        const pc4 = String(feature.properties.Name).padStart(4, "0");

        layer.on("mouseover", () => {
          layer.setStyle({ weight: 2, color: "black" });
          if (currentOrigin) showPopup(layer, pc4);
        });

        layer.on("mouseout", () => {
          layer.setStyle({ weight: 0.5, color: "#555" });
          layer.closePopup();
        });

        layer.on("click", () => {
          if (currentOrigin) showPopup(layer, pc4);
        });
      }
    }).addTo(map);

  })
  .catch(err => {
    console.error("PC4 laden mislukt:", err);
    statusEl.textContent = "PC4-gebieden laden mislukt: " + err.message;
  });

/* ------------------------------------------------------------
   POPUP
------------------------------------------------------------ */
function showPopup(layer, pc4) {
  const t = currentTimes[pc4];
  const d = currentDistances[pc4];

  let html = `<b>PC4 ${pc4}</b><br>`;
  if (t != null) {
    html += `Reistijd: ${Math.round(Number(t))} min<br>`;
    html += `Afstand: ${Number(d).toFixed(1)} km`;
  } else {
    html += `<i>Geen DTM-gegevens</i>`;
  }
  layer.bindPopup(html).openPopup();
}

/* ------------------------------------------------------------
   ORIGINS DROPDOWN
------------------------------------------------------------ */
fetch(apiUrl("/api/v1/origins"))
  .then(async r => {
    if (!r.ok) throw new Error("origins failed: " + r.status);
    return r.json();
  })
  .then(data => {
    const sel = document.getElementById("originSelect");
    (data.origins || []).forEach(pc4 => {
      const opt = document.createElement("option");
      opt.value = norm(pc4);
      opt.textContent = norm(pc4);
      sel.appendChild(opt);
    });
  })
  .catch(err => {
    console.error("Origins laden mislukt:", err);
    statusEl.textContent = "Origins laden mislukt (controleer API key).";
  });

/* ------------------------------------------------------------
   KLEURFUNCTIE
------------------------------------------------------------ */
function getColor(t) {
  if (t == null) return "#cccccc";
  if (t <= 10) return "#2c7bb6";
  if (t <= 20) return "#abd9e9";
  if (t <= 30) return "#ffffbf";
  if (t <= 45) return "#fdae61";
  if (t <= 60) return "#f46d43";
  return "#d7191c";
}

/* ------------------------------------------------------------
   CHOROPLETH UPDATE (CHUNKED, voorkomt UI-freeze)
------------------------------------------------------------ */
function updateChoroplethChunked() {
  if (!pc4Layer) return;

  const layers = [];
  pc4Layer.eachLayer(l => layers.push(l));

  let i = 0;
  const CHUNK = 200; // desktop: 150-300 is vaak fijn

  function step() {
    const end = Math.min(i + CHUNK, layers.length);
    for (; i < end; i++) {
      const layer = layers[i];
      const f = layer.feature;
      const pc4 = norm(f.properties.Name);
      const t = currentTimes[pc4];

      layer.setStyle({
        color: "#555",
        weight: 0.5,
        fillOpacity: t != null ? 0.7 : 0.1,
        fillColor: getColor(t)
      });
    }
    if (i < layers.length) {
      requestAnimationFrame(step);
    }
  }

  requestAnimationFrame(step);
}

/* ------------------------------------------------------------
   ORIGIN SELECT -> /api/v1/dtm (compact arrays)
------------------------------------------------------------ */
document.getElementById("originSelect").addEventListener("change", () => {

  const origin = norm(document.getElementById("originSelect").value);
  if (!origin) return;

  currentOrigin = origin;
  statusEl.textContent = "DTM laden voor " + origin + "...";

  // Desktop: 90 (zoals je vroeg) ‚Äì veel minder payload dan 180
  const MAX_MIN_LOAD = 240;

  const t0 = performance.now();

  fetch(apiUrl(`/api/v1/dtm?origin=${origin}&max_min=${MAX_MIN_LOAD}`))
    .then(async r => {
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      return r.json();
    })
    .then(data => {

      if (!data || !Array.isArray(data.dest) || !Array.isArray(data.t) || !Array.isArray(data.d)) {
        console.error("Onverwachte response:", data);
        statusEl.textContent = "DTM laden mislukt (onverwachte response).";
        return;
      }

      // Reset
      currentTimes = {};
      currentDistances = {};

      // Bewaar arrays (geen objecten)
      lastDest = data.dest;
      lastT = data.t;
      lastD = data.d;

      const n = Math.min(lastDest.length, lastT.length, lastD.length);

      for (let i = 0; i < n; i++) {
        const pc4 = norm(lastDest[i]);
        const timeMin = Number(lastT[i]);
        const distKm = Number(lastD[i]) / 10.0;

        currentTimes[pc4] = timeMin;
        currentDistances[pc4] = distKm;
      }

      const t1 = performance.now();
      statusEl.textContent = `DTM geladen voor ${origin} (${n} bestemmingen) ‚Äî ${Math.round(t1 - t0)} ms`;

      // Chunked repaint (voorkomt ‚Äúhang‚Äù)
      updateChoroplethChunked();
    })
    .catch(err => {
      console.error("DTM laden mislukt:", err);
      statusEl.textContent = "DTM laden mislukt (controleer API key / endpoint).";
    });
});

/* ------------------------------------------------------------
   ISOCHRONE (Set, snel)
------------------------------------------------------------ */
function showIsochrone() {
  if (!currentOrigin || !pc4Layer) return;

  const maxMin = parseFloat(document.getElementById("iso_min").value);

  if (isochroneLayer) map.removeLayer(isochroneLayer);

  const withinSet = new Set();
  const n = Math.min(lastDest.length, lastT.length);

  for (let i = 0; i < n; i++) {
    if (Number(lastT[i]) <= maxMin) withinSet.add(norm(lastDest[i]));
  }

  isochroneLayer = L.geoJSON(pc4Layer.toGeoJSON(), {
    pane: "isochronepane",
    filter: f => withinSet.has(norm(f.properties.Name)),
    style: {
      color: "purple",
      fillColor: "purple",
      fillOpacity: 0.3,
      weight: 1
    },
    interactive: false
  }).addTo(map);
}

/* ------------------------------------------------------------
   RESET
------------------------------------------------------------ */
function resetMap() {
  if (isochroneLayer) map.removeLayer(isochroneLayer);
  currentTimes = {};
  currentDistances = {};
  currentOrigin = null;
  lastDest = [];
  lastT = [];
  lastD = [];
  updateChoroplethChunked();
  statusEl.textContent = "Kaart gereset.";
}

/* ------------------------------------------------------------
   SLIDER LABEL
------------------------------------------------------------ */
function updateIsoLabel(v) {
  document.getElementById("iso_value").textContent = v;
}

/* ------------------------------------------------------------
   CSV DOWNLOAD (demo-limiet via APP_CFG.csv_max_rows)
------------------------------------------------------------ */
function downloadCSV() {
  if (!currentOrigin) return;

  const maxMin = parseFloat(document.getElementById("iso_min").value);

  const n = Math.min(lastDest.length, lastT.length, lastD.length);
  const rows = [];

  for (let i = 0; i < n; i++) {
    const t = Number(lastT[i]);
    if (t <= maxMin) {
      rows.push(i);
    }
  }

  if (!rows.length) {
    alert("Geen resultaten om te downloaden binnen de gekozen reistijd.");
    return;
  }

  let rowsLimited = rows;
  if (APP_CFG.plan === "demo" && APP_CFG.csv_max_rows && rows.length > APP_CFG.csv_max_rows) {
    rowsLimited = rows.slice(0, APP_CFG.csv_max_rows);
    alert(`Demo: download beperkt tot ${APP_CFG.csv_max_rows} rijen.`);
  }

  let csvOut = "origin_pc4,dest_pc4,time_min,distance_km\n";
  for (const idx of rowsLimited) {
    const destPc4 = norm(lastDest[idx]);
    const timeMin = Number(lastT[idx]);
    const distKm = Number(lastD[idx]) / 10.0;
    csvOut += `${currentOrigin},${destPc4},${timeMin},${distKm.toFixed(1)}\n`;
  }

  const blob = new Blob([csvOut], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `DTM_${currentOrigin}_${maxMin}min.csv`;
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
